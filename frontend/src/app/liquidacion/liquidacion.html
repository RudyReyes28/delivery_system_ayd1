<div class="liquidacion-container">
  <!-- Header con información del periodo activo -->
  <mat-card class="periodo-card" *ngIf="periodoActivo">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>schedule</mat-icon>
        Periodo Activo
      </mat-card-title>
      <!-- Botón para cerrar periodo (solo para administradores) - corregimos la comparación del estado -->
      <div class="spacer"></div>
      <button mat-raised-button color="warn" (click)="cerrarPeriodoActivo()" *ngIf="periodoActivo?.estado === 'ABIERTO'">
        <mat-icon>lock</mat-icon>
        Cerrar Periodo
      </button>
    </mat-card-header>
    <mat-card-content>
      <div class="periodo-info">
        <div class="info-item">
          <span class="label">Descripción:</span>
          <span class="value">{{ periodoActivo.descripcion }}</span>
        </div>
        <div class="info-item">
          <span class="label">Periodo:</span>
          <span class="value">
            {{ formatearFecha(periodoActivo.fechaInicio) }} - 
            {{ formatearFecha(periodoActivo.fechaFin) }}
          </span>
        </div>
        <div class="info-item">
          <span class="label">Estado:</span>
          <mat-chip [class]="'estado-' + periodoActivo.estado.toLowerCase()">
            {{ periodoActivo.estado }}
          </mat-chip>
        </div>
        <div class="info-item">
          <span class="label">Comisiones:</span>
          <span class="value">{{ formatearMoneda(periodoActivo.totalComisiones) }}</span>
        </div>
        <div class="info-item">
          <span class="label">Bonificaciones:</span>
          <span class="value">{{ formatearMoneda(periodoActivo.totalBonificaciones) }}</span>
        </div>
        <div class="info-item">
          <span class="label">Deducciones:</span>
          <span class="value">{{ formatearMoneda(periodoActivo.totalDeducciones) }}</span>
        </div>
        <div class="info-item">
          <span class="label">Total Neto:</span>
          <span class="value total-neto">{{ formatearMoneda(periodoActivo.totalNeto) }}</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Formulario para nuevo periodo -->
  <mat-card class="nuevo-periodo-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>add_circle</mat-icon>
        Crear Nuevo Periodo
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form class="nuevo-periodo-form">
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descripción del Periodo</mat-label>
            <input matInput [(ngModel)]="nuevoPeriodo.descripcion" name="descripcion" 
                   placeholder="Ej: Periodo Q1 2025" required>
            <mat-icon matSuffix>description</mat-icon>
          </mat-form-field>
        </div>
        
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Fecha de Inicio</mat-label>
            <input matInput type="date" [(ngModel)]="nuevoPeriodo.fechaInicio" 
                   name="fechaInicio" required>
            <mat-icon matSuffix>event</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Fecha de Fin</mat-label>
            <input matInput type="date" [(ngModel)]="nuevoPeriodo.fechaFin" 
                   name="fechaFin" required>
            <mat-icon matSuffix>event</mat-icon>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button mat-raised-button color="primary" 
                  (click)="crearNuevoPeriodo()" 
                  [disabled]="cargando">
            <mat-icon>save</mat-icon>
            Crear Periodo
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Tabla de repartidores (ahora ocupa todo el ancho) -->
  <mat-card class="tabla-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>people</mat-icon>
        Repartidores y Liquidaciones
      </mat-card-title>
      <div class="spacer"></div>
      <button mat-icon-button (click)="cargarDatos()" [disabled]="cargando">
        <mat-icon>refresh</mat-icon>
      </button>
    </mat-card-header>
    
    <mat-card-content>
      <div *ngIf="cargando" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando datos...</p>
      </div>

      <div *ngIf="!cargando" class="table-container">
        <table mat-table [dataSource]="repartidores" class="repartidores-table">
          <!-- Columna Nombre -->
          <ng-container matColumnDef="nombreCompleto">
            <th mat-header-cell *matHeaderCellDef>Nombre Completo</th>
            <td mat-cell *matCellDef="let element">
              <div class="nombre-cell">
                <mat-icon class="avatar-icon">person</mat-icon>
                <span>{{ element.repartidor.nombreCompleto }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Columna Email -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>Email</th>
            <td mat-cell *matCellDef="let element">
              {{ element.repartidor.email }}
            </td>
          </ng-container>

          <!-- Columna Teléfono -->
          <ng-container matColumnDef="telefono">
            <th mat-header-cell *matHeaderCellDef>Teléfono</th>
            <td mat-cell *matCellDef="let element">
              {{ element.repartidor.telefono }}
            </td>
          </ng-container>

          <!-- Columna Zona -->
          <ng-container matColumnDef="zonaAsignada">
            <th mat-header-cell *matHeaderCellDef>Zona</th>
            <td mat-cell *matCellDef="let element">
              <mat-chip class="zona-chip">
                {{ element.repartidor.zonaAsignada }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Columna Estado Liquidación -->
          <ng-container matColumnDef="estadoLiquidacion">
            <th mat-header-cell *matHeaderCellDef>Estado Liquidación</th>
            <td mat-cell *matCellDef="let element">
              <mat-chip [class]="'estado-' + obtenerEstadoLiquidacion(element.repartidor).toLowerCase().replace(' ', '-')">
                {{ obtenerEstadoLiquidacion(element.repartidor) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Columna Acciones -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let element">
              <button mat-icon-button 
                      (click)="verDetalleRepartidor(element.repartidor)"
                      matTooltip="Ver detalles">
                <mat-icon>visibility</mat-icon>
              </button>
              
              <button mat-icon-button 
                      *ngIf="!tieneLiquidacionActiva(element.repartidor)"
                      (click)="procesarLiquidacionRepartidor(element.repartidor.idRepartidor)"
                      matTooltip="Procesar liquidación"
                      color="accent"
                      [disabled]="!periodoActivo">
                <mat-icon>play_arrow</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="columnasTabla"></tr>
          <tr mat-row *matRowDef="let row; columns: columnasTabla;"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Modal de detalle de repartidor -->
  <div class="modal-overlay" *ngIf="mostrarDetalleRepartidor" (click)="cerrarDetalleRepartidor()">
    <div class="modal-content repartidor-detail-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2><mat-icon>account_circle</mat-icon> Detalles del Repartidor</h2>
        <button mat-icon-button (click)="cerrarDetalleRepartidor()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <div class="modal-body" *ngIf="repartidorSeleccionado">
        <!-- Información Personal -->
        <div class="detail-section">
          <h3><mat-icon>person</mat-icon> Información Personal</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Nombre:</label>
              <span class="highlight">{{ repartidorSeleccionado.nombreCompleto }}</span>
            </div>
            <div class="detail-item">
              <label>Email:</label>
              <span>{{ repartidorSeleccionado.email }}</span>
            </div>
            <div class="detail-item">
              <label>Teléfono:</label>
              <span>{{ repartidorSeleccionado.telefono }}</span>
            </div>
            <div class="detail-item">
              <label>Zona:</label>
              <mat-chip class="zona-chip">{{ repartidorSeleccionado.zonaAsignada }}</mat-chip>
            </div>
            <div class="detail-item">
              <label>Calificación:</label>
              <span class="success-rate">{{ repartidorSeleccionado.calificacionPromedio }}/5</span>
            </div>
            <div class="detail-item">
              <label>Entregas Completadas:</label>
              <span class="success-count">{{ repartidorSeleccionado.totalEntregasCompletadas }}</span>
            </div>
          </div>
        </div>

        <!-- Información de Empleado -->
        <div class="detail-section">
          <h3><mat-icon>badge</mat-icon> Información de Empleado</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Código:</label>
              <span>{{ repartidorSeleccionado.empleadoDetalle.codigoEmpleado }}</span>
            </div>
            <div class="detail-item">
              <label>Estado:</label>
              <mat-chip [class]="'estado-' + repartidorSeleccionado.empleadoDetalle.estadoEmpleado.toLowerCase()">
                {{ repartidorSeleccionado.empleadoDetalle.estadoEmpleado }}
              </mat-chip>
            </div>
          </div>
        </div>

        <!-- Información del Contrato -->
        <div class="detail-section">
          <h3><mat-icon>description</mat-icon> Información del Contrato</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Tipo:</label>
              <span>{{ repartidorSeleccionado.contratoDetalle.tipoContrato }}</span>
            </div>
            <div class="detail-item">
              <label>Fecha Inicio:</label>
              <span>{{ formatearFecha(repartidorSeleccionado.contratoDetalle.fechaInicio) }}</span>
            </div>
            <div class="detail-item">
              <label>Fecha Fin:</label>
              <span>{{ formatearFecha(repartidorSeleccionado.contratoDetalle.fechaFin) }}</span>
            </div>
            <div class="detail-item">
              <label>Estado:</label>
              <mat-chip [class]="'estado-' + repartidorSeleccionado.contratoDetalle.estadoContrato.toLowerCase()">
                {{ repartidorSeleccionado.contratoDetalle.estadoContrato }}
              </mat-chip>
            </div>
          </div>
        </div>

        <!-- Información de Liquidación -->
        <div class="detail-section" *ngIf="tieneLiquidacionActiva(repartidorSeleccionado)">
          <h3><mat-icon>account_balance_wallet</mat-icon> Liquidación Actual</h3>
          <div class="liquidacion-details">
            <div class="detail-grid">
              <div class="detail-item">
                <label>Total Entregas:</label>
                <span>{{ repartidorSeleccionado.liquidacionRepartidor.totalEntregas || 0 }}</span>
              </div>
              <div class="detail-item">
                <label>Estado:</label>
                <mat-chip [class]="'estado-' + (repartidorSeleccionado.liquidacionRepartidor.estado || 'pendiente').toLowerCase()">
                  {{ repartidorSeleccionado.liquidacionRepartidor.estado || 'PENDIENTE' }}
                </mat-chip>
              </div>
            </div>

            <div class="liquidacion-financiera">
              <div class="detail-item">
                <label>Comisiones:</label>
                <span class="value money positive">{{ formatearMoneda(repartidorSeleccionado.liquidacionRepartidor.totalComisiones) }}</span>
              </div>
              <div class="detail-item">
                <label>Bonificaciones:</label>
                <span class="value money positive">{{ formatearMoneda(repartidorSeleccionado.liquidacionRepartidor.totalBonificaciones) }}</span>
              </div>
              <div class="detail-item">
                <label>Deducciones:</label>
                <span class="value money negative">{{ formatearMoneda(repartidorSeleccionado.liquidacionRepartidor.totalDeducciones) }}</span>
              </div>
              <div class="detail-item">
                <label>Descuento IGSS:</label>
                <span class="value money negative">{{ formatearMoneda(repartidorSeleccionado.liquidacionRepartidor.descuentoIgss) }}</span>
              </div>
              <div class="detail-item">
                <label>Descuento ISR:</label>
                <span class="value money negative">{{ formatearMoneda(repartidorSeleccionado.liquidacionRepartidor.descuentoIsr) }}</span>
              </div>
              <div class="detail-item total-neto-item">
                <label>Total Neto:</label>
                <span class="value money total">{{ formatearMoneda(repartidorSeleccionado.liquidacionRepartidor.totalNeto) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Sin Liquidación -->
        <div class="detail-section" *ngIf="!tieneLiquidacionActiva(repartidorSeleccionado)">
          <h3><mat-icon>warning</mat-icon> Sin Liquidación</h3>
          <div class="no-liquidacion-container">
            <p class="no-liquidacion-text">Este repartidor no tiene una liquidación activa en el periodo actual.</p>
            <button mat-raised-button 
                    color="primary" 
                    (click)="procesarLiquidacionRepartidor(repartidorSeleccionado.idRepartidor)"
                    [disabled]="!periodoActivo">
              <mat-icon>play_arrow</mat-icon>
              Procesar Liquidación
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>